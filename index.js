require("dotenv/config");
const TelegramBot = require(`node-telegram-bot-api`)
const scanUrl = require("./modules/scanUrl.js");

const TOKEN = process.env.TOKEN_TELEGRAM

const bot = new TelegramBot(TOKEN, {
    polling: true
})


//bot.onText(/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/, (msg, match) => {
bot.on("message", msg => {
    const chatId = msg.chat.id;
    const clientId = msg.clientId;
    const msgId = msg.message_id

    if (msg.text.link()) {

        bot.sendMessage(chatId, "Link identificado!")
        let link = msg.text.substr(msg.text.lastIndexOf("http"))
        try {
            scanUrl(link).then(result => {
                if (result.modal == "results_modal_safe") {
                    bot.sendMessage(chatId, "âœ…O link parece estar limpo de ameaÃ§as");
                } else if (result.modal == "results_modal_malicious") {
                    bot.sendMessage(chatId, "âš  O Link foi identificado como sendo Suspeito!âš ");
                    bot.deleteMessage(chatId, msgId)
                    bot.sendMessage(chatId, "ğŸ›¡O link foi apagado por questÃµes de seguranÃ§a!")

                    bot.onReplyToMessage(chatId, msgId, bot.sendMessage(chatId, "ğŸš« Ã‰ proibido enviar links maliciosos e vocÃª estÃ¡ sujeito a puniÃ§Ãµes! âš°"))



                } else if (result.modal == "results_modal_fail") {
                    bot.sendMessage(chatId,
                        "Falha ao analisar o linkâ—\nSempre tenha cuidado ao acessar links â˜ "
                    );
                } else {
                    bot.sendMessage(chatId,
                        "O Link nÃ£o pode ser analisadoâ—\nSempre tenha cuidado ao acessar links â˜ "
                    );
                }
            });
        } catch (error) {

        }
    }
});