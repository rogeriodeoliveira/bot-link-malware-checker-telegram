require("dotenv/config");
const {
    exec
} = require('child_process');
const TelegramBot = require(`node-telegram-bot-api`)
const scan_url = require("./modules/scan_url.js");
const {
    link
} = require("fs");

const TOKEN = process.env.TOKEN_TELEGRAM

const bot = new TelegramBot(TOKEN, {
    polling: true
})

//Regex to extract URLs from text
const regex_urls = /\S*\w+\.[a-zA-Z0-9-_/?=&()#]+/g
const regex_rm_mail = /\S+@\S+/g


bot.on("message", msg => {
    const chatId = msg.chat.id;
    const msgId = msg.message_id

    let links = msg.text.match(regex_urls)

    if (links != null) {
        let i = 0
        while (i < links.length) {
            if (links[i] != links[i].match(regex_rm_mail)) {
                console.log(`Consultando url: ${links[i]}`)
                prepare_url(links[i])
            } else {
                console.log(`${links[i]} -> E-mail`)
            }
            i++
        }
    }

    function prepare_url(link) {
        let link_s = link.toString()

        // Regex for remove http:  or https://
        regex_rm_http = /(?:https?:\/\/)/
        regex_rm_www = /(www.)/

        // Regex for include http://
        url = link_s.replace(regex_rm_http, "")
        url = url.replace(regex_rm_www, "")
        url = `http://${url}`

        status_url(url)
    }

    function status_url(url) {
        exec(`curl I --max-time 5 ${url}`, (error, stdout, stderr) => {
            if (error) {
                //console.error(`exec error: ${error}`);
                return 0;
            } else {
                check_url(url)
            }
            //console.log(`stdout: ${stdout}`);
            //console.error(`stderr: ${stderr}`);
        });
    }

    function check_url(url) {
        try {
            scan_url(url).then(result => {
                if (result.modal == "results_modal_safe") {
                    bot.sendMessage(chatId, `${url} ✅ Parece estar limpo de ameaças`);
                } else if (result.modal == "results_modal_malicious") {
                    bot.deleteMessage(chatId, msgId)
                    bot.sendMessage(chatId, "⚠O link foi identificado como sendo Suspeito!⚠ \n🛡 e foi apagado por questões de segurança!")
                    bot.onReplyToMessage(chatId, msgId, bot.sendMessage(chatId, "🚫 É proibido enviar links maliciosos \n e você está sujeito a punições! ⚰"))



                } else if (result.modal == "results_modal_fail") {
                    bot.sendMessage(chatId,
                        "Falha ao analisar o link❗\nSempre tenha cuidado ao acessar links ☠"
                    );
                } else {
                    bot.sendMessage(chatId,
                        "O Link não pode ser analisado❗\nSempre tenha cuidado ao acessar links ☠"
                    );
                }
            });
        } catch (error) {
            console.log(error)
        }
    }

});