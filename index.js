require("dotenv/config");
const {
    exec
} = require('child_process');
const TelegramBot = require(`node-telegram-bot-api`)
const scanUrl = require("./modules/scanUrl.js");

const TOKEN = process.env.TOKEN_TELEGRAM

const bot = new TelegramBot(TOKEN, {
    polling: true
})

//Regex to extract URLs from texto
const regex_urls = /\S*\w+\.[a-zA-Z0-9-_/?=&()#]+/
const regex_rm_mail = /\S+@\S+/


bot.on("message", msg => {
    const chatId = msg.chat.id;
    const clientId = msg.chat.username;
    const msgId = msg.message_id

    let link = msg.text.match(regex_rm_mail) ? null : msg.text.match(regex_urls)
    if (link != null) {
        let link_s = link.toString()

        // Regex for remove http:  or https://
        regex_rm_http = /(?:https?:\/\/)/
        regex_rm_www = /(www.)/

        // Regex for include http://
        url = link_s.replace(regex_rm_http, "")
        url = url.replace(regex_rm_www, "")
        url = `http://${url}`

        exec(`curl I --max-time 5 ${url}`, (error, stdout, stderr) => {
            if (error) {
                //console.error(`exec error: ${error}`);
                return 0;
            } else {
                scan_url(url)
            }
            //console.log(`stdout: ${stdout}`);
            //console.error(`stderr: ${stderr}`);
        });

    }

    function scan_url(url) {
        try {
            scanUrl(url).then(result => {
                if (result.modal == "results_modal_safe") {
                    bot.sendMessage(chatId, `${url} ✅ Parece estar limpo de ameaças`);
                } else if (result.modal == "results_modal_malicious") {
                    bot.sendMessage(chatId, "⚠ O Link foi identificado como sendo Suspeito!⚠");
                    bot.deleteMessage(chatId, msgId)
                    bot.sendMessage(chatId, "🛡O link foi apagado por questões de segurança!")

                    bot.onReplyToMessage(chatId, msgId, bot.sendMessage(chatId, `${clientId} 🚫 É proibido enviar links maliciosos e você está sujeito a punições! ⚰`))


                } else if (result.modal == "results_modal_fail") {
                    bot.sendMessage(chatId,
                        "Falha ao analisar o link❗\nSempre tenha cuidado ao acessar links ☠"
                    );
                } else {
                    bot.sendMessage(chatId,
                        "O Link não pode ser analisado❗\nSempre tenha cuidado ao acessar links ☠"
                    );
                }
            });
        } catch (error) {
            console.log(error)
        }
    }

});